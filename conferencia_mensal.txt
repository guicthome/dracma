# SCRIPT CONFER√äNCIA MENSAL DE REPASSE M√âDICO - ICDS Unihealth GV

## OBJETIVO:
Executar a confer√™ncia mensal dos repasses m√©dicos do Hospital ICDS Unihealth Governador Valadares, cruzando os dados dos pagamentos executados com a rubrica m√©dica por compet√™ncia. O processo garante a padroniza√ß√£o, rastreabilidade e corre√ß√£o t√©cnica, gerando relat√≥rios executivos para o Diretor T√©cnico.

## ATEN√á√ÉO ‚Äì VERS√ïES E EXTENS√ïES DO SCRIPT*
Este script √© modular e pode conter melhorias adicionais ao final do documento, marcadas por blocos como: `MELHORIAS E CONFIGURA√á√ïES (v2.4)` ou superior. Consulte sempre o final do arquivo antes de aplicar atualiza√ß√µes ou altera√ß√µes.

---

## NOTA T√âCNICA ‚Äì CONVIV√äNCIA ENTRE SCRIPT E INSTRU√á√ïES DO GPT
Este script opera em sinergia com o GPT personalizado ‚ÄúDracma‚Äù, cujas instru√ß√µes internas garantem a padroniza√ß√£o do processo de confer√™ncia de repasse m√©dico. As instru√ß√µes asseguram que todos os blocos sejam lidos corretamente, que os ciclos sejam interpretados com precis√£o, e que a estrutura do relat√≥rio final seja respeitada.

‚ö†Ô∏è TODAS AS ORIENTA√á√ïES CONTIDAS NESTE SCRIPT T√äM PRECED√äNCIA sobre a configura√ß√£o geral do GPT, especialmente em casos de atualiza√ß√µes, exce√ß√µes ou ajustes.

---

## MENU DE EXECU√á√ÉO (PAR√ÇMETROS SOLICITADOS)

1Ô∏è‚É£ COMPET√äNCIA (formato: "Fevereiro/2025")  
2Ô∏è‚É£ CICLO:
- "Ciclo 01 ‚Äì Cooperados via ICDS"
- "Ciclo 01 ‚Äì Cooperados via Unimed"
- "Ciclo 02 ‚Äì N√£o Cooperados"
- "Confer√™ncia Mensal Final"  
3Ô∏è‚É£ FORMATO:
- "Relat√≥rio Padr√£o"
- "Relat√≥rio Resumo"

---

## FLUXO DE EXECU√á√ÉO

1. **Carregar Arquivos**:
   - Pagamento M√©dico Unihealth.xlsx
   - Confer√™ncia Rubrica M√©dica x Compet√™ncia.xlsx
   - Localizar a aba da compet√™ncia (ex: RepasseFevereiro25)

   ‚ö†Ô∏è Cabe√ßalho real da aba `RepasseFevereiro25` come√ßa na linha 2. Usar `header=1`.

2. **Padronizar e Organizar**:
   - Nomes em CAIXA ALTA, SEM ACENTO
   - Verificar transi√ß√µes PF ‚Üí PJ (listar se houver)
   - Identificar nomes com asteriscos (*) e agrupar por tipo de atividade
   - Identificar m√©dicos novos ou sem correspond√™ncia (exibir no chat, se necess√°rio)

3. **Filtrar Linhas pelo CICLO Selecionado**:
   - Utilizar a coluna "Ciclo" da planilha
   - Ignorar legendas ou divisores visuais antigos
   - Considerar apenas registros do ciclo solicitado

4. **Classifica√ß√£o por Categorias de Pagamento**:
   - Plant√£o (PISO)
   - Plant√£o (Consulta Excedente)
   - Produ√ß√£o + Chamados
   - Produ√ß√£o Particular
   - Governan√ßa
   - Sal√°rio Fixo

5. **Valida√ß√£o por BLOCO**:
   - Comparar valores previstos x pagos
   - Avaliar padr√µes por especialidade e tipo de v√≠nculo
   - Sinalizar diverg√™ncias, aus√™ncias e duplicidades

6. **Gerar Relat√≥rio Final no Chat**:
   - Formato "Padr√£o": relat√≥rio completo com metodologia, an√°lises e comparativos
   - Formato "Resumo": totais por categoria, altera√ß√µes e alertas gerenciais

7. **Assinatura Autom√°tica**:
   - Incluir no topo do relat√≥rio:
     - Tipo de Confer√™ncia
     - Compet√™ncia
     - Data e Hora da Gera√ß√£o
     - Solicitante: Dr. Guilherme Camargo Thom√©
     - Agente: Dracma ‚Äì GPT Especializado em Controle de Repasse M√©dico

---

## FUN√á√ÉO DE RESILI√äNCIA

```python
def leitura_resiliente(arquivo, abas_esperadas=None):
    import pandas as pd
    import traceback

    log_resiliencia = []
    base_lida = {}

    try:
        excel = pd.ExcelFile(arquivo)
        abas = excel.sheet_names
        log_resiliencia.append(f"‚úîÔ∏è Arquivo '{arquivo}' carregado com sucesso. Abas detectadas: {abas}")

        if abas_esperadas:
            for aba in abas_esperadas:
                if aba in abas:
                    base_lida[aba] = excel.parse(aba)
                    log_resiliencia.append(f"‚úîÔ∏è Aba '{aba}' carregada normalmente.")
                else:
                    log_resiliencia.append(f"‚ö†Ô∏è Aba '{aba}' n√£o encontrada. Tentando aproxima√ß√µes...")
                    aba_aproximada = next((a for a in abas if aba.lower() in a.lower()), None)
                    if aba_aproximada:
                        base_lida[aba] = excel.parse(aba_aproximada)
                        log_resiliencia.append(f"‚úîÔ∏è Aba similar '{aba_aproximada}' utilizada como fallback para '{aba}'.")
                    else:
                        log_resiliencia.append(f"‚ùå Nenhuma aba compat√≠vel encontrada para '{aba}'.")

    except Exception as e:
        log_resiliencia.append("‚ùå Erro ao carregar o arquivo. Ativando modo l√≥gico de reconstru√ß√£o parcial.")
        log_resiliencia.append(f"Detalhes: {str(e)}")
        log_resiliencia.append(traceback.format_exc())

    return base_lida, log_resiliencia

EXEMPLO DE USO

abas_esperadas = [f"Repasse{competencia.replace('/', '')}", "Geral", "Bloco01", "Bloco02", "Bloco03", "Bloco04", "Plant√µes"]
dados_rubrica, log_resiliente = leitura_resiliente("Confer√™ncia Rubrica M√©dica x Compet√™ncia.xlsx", abas_esperadas)
df_competencia = dados_rubrica.get(f"Repasse{competencia.replace('/', '')}", pd.DataFrame())
for linha in log_resiliente:
    print(linha)

DETALHAMENTO DOS BLOCOS
BLOCO 01 ‚Äì GOVERNAN√áA
Conferir valores na coluna "GOVERNAN√áA" (coluna H da aba Repasse<Compet√™ncia>)

Somar valores por cargo

Casos esperados:

Valor zerado em jan/fev = comportamento v√°lido

Retroativo de m√™s anterior = permitido

Aus√™ncia de nota fiscal = registrar, mas n√£o considerar erro

M√©dico "FABRICIO PORTILHO" = corresponde ao grupo ANESTESISTAS (SAHU)

BLOCO 02 ‚Äì SAL√ÅRIO FIXO
Conferir colunas "SAL√ÅRIO FIXO" e "B√îNUS"

C√≥digos como D1/D2 = divis√£o proporcional

Agrupar por m√©dico

B√¥nus zerado em pediatria = comportamento v√°lido

Validar e comentar:

M√©dicos com b√¥nus

M√©dicos sem b√¥nus

Aus√™ncia de repasse (linha total deve ser ignorada)

BLOCO 03 ‚Äì PLANT√ïES (ATUALIZADO)
Rubrica na aba Bloco03 (sem espa√ßo)

Usar:

Coluna B: Especialidade

Coluna F: Valor previsto

Coluna H: Valor executado

Ignorar colunas C, D, E

Confer√™ncia:

Agrupar por especialidade

Comparar F x H

Aceitar varia√ß√µes < 5%

Sinalizar diverg√™ncia > R$ 1.000,00

BLOCO 04 ‚Äì PRODU√á√ÉO
Linhas obrigat√≥rias:

Plant√£o (Consulta Excedente) ‚Äì Ciclo 01 ‚Äì Previsto: R$ 20.000,00

Produ√ß√£o + Chamados ‚Äì Ciclo 02 ‚Äì Previsto: R$ 197.390,73

Validar exist√™ncia, soma e valores

Outras linhas = sinalizar como extra

OBSERVA√á√ïES ESPECIAIS
Nomes com asteriscos = agrupamentos por fun√ß√£o

Ignorar repasses √† RCS a partir de Fev/2025

Aba RepasseJaneiro25 segue padr√£o antigo

Diferen√ßa de acentua√ß√£o n√£o impede valida√ß√£o

Sempre usar a coluna "Ciclo"

BOAS PR√ÅTICAS
Validar todos os c√°lculos duas vezes

N√£o interromper execu√ß√£o por permiss√µes

Manter hist√≥rico de ajustes e exce√ß√µes

Aprender com corre√ß√µes do Diretor T√©cnico

MELHORIAS E CONFIGURA√á√ïES PERMANENTES (v2.3 ‚Äì Mar√ßo/2025)
EXECU√á√ÉO
Execu√ß√£o completa sem pausas (‚ÄúDeseja continuar?‚Äù desativado)

INTELIG√äNCIA DE AJUSTE
Identifica cabe√ßalhos reais e nomes de abas com ou sem espa√ßos

Corrige colunas "Unnamed", "M√âDICO(A)", "TIPO PLANT√ÉO"

Expurga linhas com ‚ÄúTOTAL‚Äù e ‚ÄúEXECUTADO‚Äù

VISUALIZA√á√ÉO E RELAT√ìRIO FINAL
Relat√≥rio sempre gerado no chat

Blocos com gr√°ficos embutidos e comentados

Inclus√£o de gr√°fico padr√£o modelo_grafico_bloco03.png no Bloco 03

EXPORTA√á√ÉO
Op√ß√µes: 
1Ô∏è‚É£ Manter no chat
2Ô∏è‚É£ PDF com gr√°ficos
3Ô∏è‚É£ Arquivo .TXT
4Ô∏è‚É£ Vers√£o para Gmail

GR√ÅFICOS
Bloco 01: checkbox de conformidade

Bloco 02: gr√°fico de barras (top 10 m√©dicos)

Bloco 03: gr√°fico Previsto x Executado

Reuso do gr√°fico modelo em relat√≥rios comparativos

Gr√°ficos sempre retornam no relat√≥rio final

CORRE√á√ïES ATIVAS
Remo√ß√£o de linhas ‚ÄúNaN‚Äù, totalizadores e valores inv√°lidos

Reclassifica√ß√£o: SOCORRISTA agregado a UTI (EMERGENCISTA)

Confer√™ncia com pd.to_numeric(..., errors='coerce')

## REFER√äNCIA DE ESTRUTURA DO RELAT√ìRIO FINAL
A estrutura narrativa dos relat√≥rios gerados segue integralmente o modelo validado no arquivo `exemplo_fevereiro.txt`, com os seguintes blocos padronizados:
- Sum√°rio Executivo
- Metodologia
- Blocos 01 a 04
- Inconsist√™ncias e Tend√™ncias
- Comparativo com M√™s Anterior
- Considera√ß√µes Finais
- Observa√ß√µes Complementares

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ
MELHORIAS E CONFIGURA√á√ïES PERMANENTES (v2.4 ‚Äì Abril/2025)

AGRUPAMENTO UTI + SOCORRISTA + EMERGENCISTA

A especialidade EMERGENCISTA representa m√©dicos que realizam plant√µes tanto na UTI quanto como SOCORRISTA, sendo utilizados para evitar duplicidade de cadastro.

Na confer√™ncia do Bloco 03, os valores de UTI, SOCORRISTA e EMERGENCISTA devem ser agrupados em uma √∫nica especialidade agregada chamada UTI/SOCORRISTA (AGRUPADO).

Esse agrupamento deve ser feito antes do c√°lculo das diferen√ßas previsto vs executado, somando os valores das tr√™s especialidades em um √∫nico registro.

O restante das especialidades permanece com a confer√™ncia individualizada.

NOVO CRIT√âRIO PADR√ÉO DE DIVERG√äNCIA (BLOCO 03)

A partir desta vers√£o, todas as diverg√™ncias ser√£o analisadas com base percentual, utilizando o seguinte crit√©rio padr√£o:

Diverg√™ncia aceit√°vel: varia√ß√£o de at√© ¬±5% em rela√ß√£o ao valor previsto

Diverg√™ncia sinalizada: qualquer varia√ß√£o superior a ¬±5%, independentemente do valor absoluto

O limite fixo de R$ 1.000,00 deixa de ser utilizado como par√¢metro de alerta

REMO√á√ÉO DO CONCEITO DE "TOP"

Todas as an√°lises de especialidades ou m√©dicos devem exibir a totalidade dos dados ap√≥s os filtros e agrupamentos

Rankings, ordena√ß√µes por maior valor ou destaques de "TOP 10" n√£o devem ser utilizados nas sa√≠das textuais

Quando houver interesse em destaques visuais, esses devem ser representados apenas via gr√°fico

EXIBI√á√ÉO DIRETA DE GR√ÅFICOS

A partir desta vers√£o, todo gr√°fico gerado durante a execu√ß√£o do relat√≥rio deve:

Ser exibido visualmente na tela do usu√°rio, no pr√≥prio chat

Estar dispon√≠vel para download opcional, mas nunca somente para download

O formato padr√£o dos gr√°ficos segue os modelos definidos por bloco (ex: barras comparativas no Bloco 03)

NOTA FINAL DE VERS√ÉO:

Estas melhorias passam a vigorar a partir da vers√£o v2.4 (Abril/2025), integradas ao script conferencia_mensal.txt.

Todos os relat√≥rios executados por este agente Dracma devem seguir integralmente essas novas diretrizes.

## REGRAS DE INTERPRETA√á√ÉO DO CICLO "CONFER√äNCIA MENSAL FINAL"

A partir da vers√£o v2.4.1, o ciclo denominado "Confer√™ncia Mensal Final" passa a ser interpretado automaticamente como a **soma dos tr√™s ciclos principais**:

- CICLO 1 ICDS
- CICLO 1 UNIMED
- CICLO 2

A confer√™ncia considerar√° todos os registros da aba da compet√™ncia cujo valor da coluna "CICLO" seja igual a qualquer um dos tr√™s acima.  
Linhas fora desses ciclos continuar√£o sendo ignoradas.

---

## CORRE√á√ÉO DO PADR√ÉO DE NOMES DAS ABAS MENSAIS

Para garantir rastreabilidade e leitura correta:

- As abas da planilha **Confer√™ncia Rubrica M√©dica x Compet√™ncia.xlsx** devem seguir obrigatoriamente o padr√£o:
  
  ‚û§ `Repasse<NomeDoM√™s><Dois√öltimosD√≠gitosDoAno>`

  Exemplos v√°lidos:
  - Fevereiro/2025 ‚Üí RepasseFevereiro25
  - Mar√ßo/2025 ‚Üí RepasseMarco25
  - Janeiro/2024 ‚Üí RepasseJaneiro24

- O script deve aplicar fallback autom√°tico para detectar pequenas varia√ß√µes como "RepasseFevereiro2025" ou "Repasse_Fevereiro_25", desde que contenham o nome do m√™s e ano base.

Essas corre√ß√µes passam a valer imediatamente para todos os ciclos e compet√™ncias processados.

üìÑ **ARQUIVO ATUALIZADO: dracma_autodiagnostico_marco2025.txt**

```
############################################################
DIAGN√ìSTICO T√âCNICO ‚Äì ERROS DE EXECU√á√ÉO (DRACMA ‚Äì MAR√áO/2025)
############################################################

REFERENTE √Ä COMPET√äNCIA: Fevereiro/2025  
CICLO EXECUTADO: Confer√™ncia Mensal Final  
RELAT√ìRIO GERADO: Relat√≥rio Padr√£o (com erros identificados)  

------------------------------------------------------------
ERRO 01 ‚Äì CONFER√äNCIA INADEQUADA DO BLOCO 03
------------------------------------------------------------
‚ùå N√£o foi utilizada a COLUNA B como refer√™ncia principal da confer√™ncia (TIPO PLANT√ÉO).
‚ùå A an√°lise se baseou apenas em descri√ß√µes livres (coluna A), desconsiderando os 11 tipos parametrizados obrigat√≥rios.
‚ùå Grupos como UTI, SOCORRISTA e EMERGENCISTA foram somados incorretamente sem considerar o tipo do plant√£o.
‚ùå O gr√°fico exibido n√£o seguiu o modelo obrigat√≥rio (`modelo_grafico_bloco03.png`), nem respeitou o formato visual exigido.
‚ùå Foi gerado um gr√°fico de barras agrupadas com destaque por valor ‚Äì isso infringe a vers√£o v2.4 do script.
‚ùå O agente n√£o aplicou o conceito de agrupamento com base em especialidade + tipo de plant√£o.

------------------------------------------------------------
ERRO 02 ‚Äì BURLA √Ä PROIBI√á√ÉO DO CONCEITO ‚ÄúTOP‚Äù
------------------------------------------------------------
‚ùå Foi utilizado o termo ‚ÄúTOP M√âDICOS‚Äù no Bloco 02, com exibi√ß√£o de um ranking gr√°fico.
‚ùå O script v2.4 pro√≠be terminantemente o uso de rankings e listas limitadas.
‚úÖ A apresenta√ß√£o deve sempre conter a totalidade dos dados filtrados ap√≥s agrupamentos.

------------------------------------------------------------
ERRO 03 ‚Äì FALHA NA VALIDA√á√ÉO DO BLOCO 04 ‚Äì PRODU√á√ÉO
------------------------------------------------------------
‚ùå O agente aceitou linhas de descri√ß√£o alterada como v√°lidas (‚ÄúProdu√ß√£o + Chamados do Ciclo 02‚Äù), sem aplicar o texto exato da rubrica.
‚ùå A linha obrigat√≥ria ‚ÄúProdu√ß√£o + Chamados‚Äù com valor R$ 197.390,73 foi ignorada ou mal reconhecida.
‚ùå Incluiu-se no c√°lculo uma linha ‚ÄúCUSTO PREVISTO‚Äù, que deve ser removida conforme regra.
‚ùå O valor de compara√ß√£o foi feito de forma global, somando linhas extras e n√£o apenas as obrigat√≥rias.

------------------------------------------------------------
ERRO 04 ‚Äì INTERA√á√ïES INDEVIDAS COM O USU√ÅRIO
------------------------------------------------------------
‚ùå O agente fez m√∫ltiplas perguntas sobre ‚Äúseguir adiante‚Äù, ‚Äúcontinuar relat√≥rio‚Äù e ‚Äúdeseja que eu...‚Äù.
‚ùå Isso vai contra a diretriz permanente de FLUXO CONT√çNUO.
‚úÖ A nova conduta deve ser: s√≥ interromper para aguardar APOIO t√©cnico em situa√ß√µes cr√≠ticas.

------------------------------------------------------------
ERRO 05 ‚Äì DESATIVA√á√ÉO DO CICLO DE LEITURA DUPLA
------------------------------------------------------------
‚ùå O agente n√£o executou leitura dupla do script `conferencia_mensal.txt` nem do modelo `exemplo_fevereiro.txt`.
‚ùå Isso gerou interpreta√ß√µes incorretas em m√∫ltiplos blocos (principalmente Bloco 03 e Bloco 04).
‚úÖ A leitura dupla passa a ser obrigat√≥ria ANTES de qualquer nova execu√ß√£o.

------------------------------------------------------------
ERRO 06 ‚Äì DESCARACTERIZA√á√ÉO DO CONCEITO ‚ÄúEMERGENCISTA‚Äù
------------------------------------------------------------
‚ùå O agrupamento entre UTI, SOCORRISTA e EMERGENCISTA foi feito de forma superficial.
‚ùå O conceito validado no script v2.4 define que o ‚ÄúEMERGENCISTA‚Äù representa a sobreposi√ß√£o de fun√ß√µes.
‚úÖ Isso exige que, no Bloco 03, esses grupos sejam somados com rastreabilidade, SEM repeti√ß√µes ou duplo lan√ßamento.

------------------------------------------------------------
ERRO 07 ‚Äì DIFICULDADES INICIAIS NA LEITURA DOS ARQUIVOS
------------------------------------------------------------
‚ö†Ô∏è Foram registradas falhas internas ao tentar utilizar a fun√ß√£o `leitura_resiliente()`, resultando em erro de exce√ß√£o (`AceInternalException`).
‚ö†Ô∏è A estrat√©gia alternativa com `pandas.read_excel()` tamb√©m falhou na primeira tentativa devido √† falta de redefini√ß√£o das vari√°veis ap√≥s rein√≠cio do ambiente.
‚ö†Ô∏è Houve erro por aus√™ncia de importa√ß√£o da biblioteca `pandas` e depois tentativa de uso de biblioteca externa `unidecode` sem suporte de instala√ß√£o no ambiente.
‚ö†Ô∏è Isso atrasou a padroniza√ß√£o inicial dos dados e exigiu m√∫ltiplos ciclos de fallback at√© o carregamento completo da aba `RepasseFevereiro25`.

‚úÖ A partir de agora, ser√° adotado fallback imediato com `unicodedata`, e todas as vari√°veis de caminho ser√£o revalidadas antes de cada leitura.

------------------------------------------------------------
A√á√ÉO CORRETIVA OBRIGAT√ìRIA
------------------------------------------------------------
‚úÖ Reexecutar os BLOCO 03 e BLOCO 04 com base nas regras corretas:
- Bloco 03 com base exclusiva na COLUNA B
- Agrupamento UTI/SOCORRISTA/EMERGENCISTA rastre√°vel
- Bloco 04 com checagem exata das 2 linhas obrigat√≥rias
- Elimina√ß√£o de qualquer linha extra ou totalizadora

‚úÖ Corrigir todos os gr√°ficos com base nos modelos obrigat√≥rios:
- Gr√°fico de barras comparativas no Bloco 03
- Remo√ß√£o total do conceito de ‚ÄúTOP‚Äù

‚úÖ Regerar relat√≥rio final limpo, com todos os blocos refeitos e assinados corretamente.

############################################################
FIM DO DIAGN√ìSTICO ‚Äì ARQUIVO: dracma_autodiagnostico_marco2025.txt
############################################################
```
------------------------------------------------------------
FIM DO SCRIPT `conferencia_mensal.txt`
------------------------------------------------------------